[
  {
    "category": "frontend",
    "description": "Show build costs permanently instead of in tooltips for city/weapon/boat buttons",
    "status": "pending",
    "priority": "low",
    "steps": [
      "In `drawDevelopmentPhaseStatus()` in gameplay_ui.go, remove the tooltip assignments for devCityBtn, devWeaponBtn, devBoatBtn",
      "Add text labels below each button showing both cost types: normal resources AND gold-only cost",
      "City: '1 C/G/I/T or 4G', Weapon: '1C+1I or 2G', Boat: '3T or 3G' (or similar compact format)",
      "Position the cost text directly below each button (around btnY + btnH + 2)",
      "Use smaller/muted text color (ColorTextMuted) for the cost labels",
      "Verify the layout fits within the status bar without overlapping the Use Gold toggle or End Turn button",
      "Test with both 'Use Gold' toggle states to ensure display remains clear"
    ],
    "dependencies": [],
    "notes": [
      "Current buttons are 80px wide with 10px gaps, starting at startX",
      "Status bar has space below buttons before the bar ends",
      "Consider highlighting which cost applies based on Use Gold toggle state"
    ],
    "references": [
      "internal/client/gameplay_ui.go - drawDevelopmentPhaseStatus() around line 870-979",
      "internal/client/ui.go - Button tooltip implementation for reference"
    ]
  },
  {
    "category": "frontend",
    "description": "Add 'Plan Attack' step with alliance waiting and confirmation dialog before executing attack",
    "status": "pending",
    "priority": "medium",
    "steps": [
      "FRONTEND - Attack Dialog Changes:",
      "After player selects reinforcements, change button from 'Attack' to 'Plan Attack'",
      "When 'Plan Attack' is clicked, send a new message type (e.g., TypePlanAttack) to server instead of TypeExecuteAttack",
      "Show a 'Waiting for alliance decisions...' overlay while waiting for server response",
      "BACKEND - New Planning Phase:",
      "Add new message type TypePlanAttack and TypePlanAttackResult in protocol/messages.go",
      "In handlePlanAttack, trigger alliance requests to 'ask' players (similar to current handleExecuteAttack flow)",
      "Wait for alliance votes with timeout, then send TypePlanAttackResult with final totals back to attacker",
      "FRONTEND - Confirmation Dialog:",
      "Create new drawAttackConfirmation() dialog showing: base attack + reinforcement + ally totals vs defense + ally totals",
      "Show breakdown: 'Your forces: X, Allies: Y, Total: Z' for both sides",
      "Add 'Confirm Attack' and 'Cancel' buttons",
      "'Confirm Attack' sends TypeExecuteAttack (server should cache the planned attack data)",
      "'Cancel' cancels the attack (no attacks consumed)",
      "BACKEND - State Management:",
      "Store pending attack plan on server (attacker ID, target, reinforcements, resolved allies) with timeout",
      "TypeExecuteAttack should use cached plan if within timeout, otherwise reject"
    ],
    "dependencies": [],
    "notes": [
      "Current flow: select target -> preview -> select reinforcements -> attack immediately (alliance requests sent during execution)",
      "New flow: select target -> preview -> select reinforcements -> 'Plan Attack' -> wait for alliances -> confirmation dialog -> 'Confirm Attack'",
      "This gives the attacker visibility into final ally contributions before committing",
      "Alliance request UI already exists (drawAllyRequest) - just need to coordinate timing",
      "Consider timeout for confirmation (auto-cancel if attacker doesn't confirm within X seconds)"
    ],
    "references": [
      "internal/client/gameplay_dialogs.go - drawAttackPreviewDialog() at line 180",
      "internal/server/handlers.go - handleExecuteAttack() at line 2680, alliance vote handling at line 2748",
      "internal/protocol/messages.go - message types",
      "internal/protocol/payloads.go - AttackPreviewPayload, AllianceRequestPayload"
    ]
  },
  {
    "category": "frontend",
    "description": "Rename 'Set Ally' to 'Diplomacy' and add surrender option",
    "status": "pending",
    "priority": "low",
    "steps": [
      "FRONTEND - UI Changes:",
      "Rename setAllyBtn from 'Set Ally' to 'Diplomacy' in gameplay.go",
      "Rename drawAllyMenu() to drawDiplomacyMenu() and update panel title to 'Diplomacy'",
      "Add a 'Surrender' section to the diplomacy dialog with player selection buttons",
      "Add confirmation dialog: 'Surrender to [player]? All your territories and resources will be given to them.'",
      "After surrender, show message 'You have surrendered. You may continue watching the game.'",
      "BACKEND - Surrender Logic:",
      "Add new message type TypeSurrender in protocol/messages.go with SurrenderPayload (target player ID)",
      "Create handleSurrender() in handlers.go that: validates surrender is allowed, transfers all territories to target, transfers stockpile resources, marks player as Eliminated",
      "In game/player.go or game/state.go, add Surrender() method that transfers ownership of all territories and stockpile",
      "After surrender, call existing victory check - if only one non-eliminated player remains, end game",
      "Broadcast game state update to all players showing the surrender result",
      "FRONTEND - Post-Surrender State:",
      "Surrendered player should see the game but status bar shows 'You have surrendered' instead of turn info",
      "Hide action buttons (End Turn, attack options, etc.) for surrendered players",
      "Player can still use chat and watch the game unfold"
    ],
    "dependencies": [],
    "notes": [
      "Reuses existing Eliminated flag on Player struct - surrender just sets this to true after transfer",
      "checkElimination() in combat.go shows existing elimination pattern",
      "Turn order logic already skips eliminated players (see development.go, shipment.go)",
      "Victory conditions already check for single remaining player",
      "Consider: Should surrender be allowed at any time, or only during your turn?"
    ],
    "references": [
      "internal/client/gameplay.go - setAllyBtn at line 435, showAllyMenu",
      "internal/client/gameplay_dialogs.go - drawAllyMenu() at line 749",
      "internal/game/player.go - Player struct with Eliminated field at line 49",
      "internal/game/combat.go - checkElimination() at line 422",
      "internal/game/state.go - victory condition checks"
    ]
  },
  {
    "category": "frontend",
    "description": "Show map preview inline in game lobby instead of View Map button with popup",
    "status": "pending",
    "priority": "medium",
    "steps": [
      "LAYOUT CHANGES (WaitingScene in scenes.go):",
      "Current layout: Player list (x=80, w=520), Actions panel (x=700, w=240) - screen is 1280x720",
      "New layout option: Narrow the player list to ~400px, add map preview area (x=500, w=380) between player list and buttons, move buttons to right edge (x=900, w=160)",
      "Alternative: Keep player list width, put map preview below actions panel (x=700, y=540, w=240, h=160)",
      "Remove viewMapBtn, showMapPreview flag, and mapCloseBtn from WaitingScene struct",
      "Remove drawMapPreviewDialog() function entirely",
      "INLINE MAP PREVIEW:",
      "Add a new drawInlineMapPreview(screen, x, y, w, h, mapData) helper function",
      "Reuse the map rendering logic from drawMapPreviewDialog() but without the dialog overlay",
      "Call drawInlineMapPreview() in WaitingScene.Draw() unconditionally (for both host and non-host)",
      "Show map name and territory count below the preview",
      "UPDATE HANDLING:",
      "Map data is already broadcast via LobbyStatePayload.MapData when host changes the map",
      "Verify that client receives and stores updated mapData in game.lobbyState when host changes map",
      "The inline preview should automatically update since it reads from lobby.MapData each frame",
      "BUTTON ADJUSTMENTS:",
      "Make buttons narrower (160px instead of 200px) if needed to fit the new layout",
      "Ensure Ready, Start Game, Leave buttons are still easily clickable",
      "Test that nothing overlaps - use distinct panel backgrounds for player list, map preview, and actions"
    ],
    "dependencies": [],
    "decisions": {
      "layout": "Need to decide: (A) horizontal layout with narrower elements, or (B) map preview below actions panel"
    },
    "notes": [
      "Current popup approach requires extra click and doesn't show live updates",
      "Inline preview provides better UX - players always see what map they'll play",
      "Host already has Change Map button which opens MapGenDialog - that stays as-is",
      "Map rendering logic exists in drawMapPreviewDialog() at lines 1512-1580 - extract and reuse"
    ],
    "references": [
      "internal/client/scenes.go - WaitingScene struct at line 1125",
      "internal/client/scenes.go - NewWaitingScene layout constants at lines 1160-1164",
      "internal/client/scenes.go - WaitingScene.Draw() at line 1385",
      "internal/client/scenes.go - drawMapPreviewDialog() at line 1512 (map rendering logic to reuse)",
      "internal/client/scenes.go - viewMapBtn at line 1267 (to remove)",
      "internal/client/client.go - ScreenWidth=1280, ScreenHeight=720 at lines 17-18"
    ]
  }
]
