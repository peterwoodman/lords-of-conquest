[
  {
    "category": "frontend",
    "description": "Add 'Plan Attack' step with alliance waiting and confirmation dialog before executing attack",
    "status": "pending",
    "priority": "medium",
    "steps": [
      "FRONTEND - Attack Dialog Changes:",
      "After player selects reinforcements, change button from 'Attack' to 'Plan Attack'",
      "When 'Plan Attack' is clicked, send a new message type (e.g., TypePlanAttack) to server instead of TypeExecuteAttack",
      "Show a 'Waiting for alliance decisions...' overlay while waiting for server response",
      "BACKEND - New Planning Phase:",
      "Add new message type TypePlanAttack and TypePlanAttackResult in protocol/messages.go",
      "In handlePlanAttack, trigger alliance requests to 'ask' players (similar to current handleExecuteAttack flow)",
      "Wait for alliance votes with timeout, then send TypePlanAttackResult with final totals back to attacker",
      "FRONTEND - Confirmation Dialog:",
      "Create new drawAttackConfirmation() dialog showing: base attack + reinforcement + ally totals vs defense + ally totals",
      "Show breakdown: 'Your forces: X, Allies: Y, Total: Z' for both sides",
      "Add 'Confirm Attack' and 'Cancel' buttons",
      "'Confirm Attack' sends TypeExecuteAttack (server should cache the planned attack data)",
      "'Cancel' cancels the attack (no attacks consumed)",
      "BACKEND - State Management:",
      "Store pending attack plan on server (attacker ID, target, reinforcements, resolved allies) with timeout",
      "TypeExecuteAttack should use cached plan if within timeout, otherwise reject"
    ],
    "dependencies": [],
    "notes": [
      "Current flow: select target -> preview -> select reinforcements -> attack immediately (alliance requests sent during execution)",
      "New flow: select target -> preview -> select reinforcements -> 'Plan Attack' -> wait for alliances -> confirmation dialog -> 'Confirm Attack'",
      "This gives the attacker visibility into final ally contributions before committing",
      "Alliance request UI already exists (drawAllyRequest) - just need to coordinate timing",
      "Consider timeout for confirmation (auto-cancel if attacker doesn't confirm within X seconds)"
    ],
    "references": [
      "internal/client/gameplay_dialogs.go - drawAttackPreviewDialog() at line 180",
      "internal/server/handlers.go - handleExecuteAttack() at line 2680, alliance vote handling at line 2748",
      "internal/protocol/messages.go - message types",
      "internal/protocol/payloads.go - AttackPreviewPayload, AllianceRequestPayload"
    ]
  },
  {
    "category": "frontend",
    "description": "Rename 'Set Ally' to 'Diplomacy' and add surrender option",
    "status": "pending",
    "priority": "low",
    "steps": [
      "FRONTEND - UI Changes:",
      "Rename setAllyBtn from 'Set Ally' to 'Diplomacy' in gameplay.go",
      "Rename drawAllyMenu() to drawDiplomacyMenu() and update panel title to 'Diplomacy'",
      "Add a 'Surrender' section to the diplomacy dialog with player selection buttons",
      "Add confirmation dialog: 'Surrender to [player]? All your territories and resources will be given to them.'",
      "After surrender, show message 'You have surrendered. You may continue watching the game.'",
      "BACKEND - Surrender Logic:",
      "Add new message type TypeSurrender in protocol/messages.go with SurrenderPayload (target player ID)",
      "Create handleSurrender() in handlers.go that: validates surrender is allowed, transfers all territories to target, transfers stockpile resources, marks player as Eliminated",
      "In game/player.go or game/state.go, add Surrender() method that transfers ownership of all territories and stockpile",
      "After surrender, call existing victory check - if only one non-eliminated player remains, end game",
      "Broadcast game state update to all players showing the surrender result",
      "FRONTEND - Post-Surrender State:",
      "Surrendered player should see the game but status bar shows 'You have surrendered' instead of turn info",
      "Hide action buttons (End Turn, attack options, etc.) for surrendered players",
      "Player can still use chat and watch the game unfold"
    ],
    "dependencies": [],
    "notes": [
      "Reuses existing Eliminated flag on Player struct - surrender just sets this to true after transfer",
      "checkElimination() in combat.go shows existing elimination pattern",
      "Turn order logic already skips eliminated players (see development.go, shipment.go)",
      "Victory conditions already check for single remaining player",
      "Consider: Should surrender be allowed at any time, or only during your turn?"
    ],
    "references": [
      "internal/client/gameplay.go - setAllyBtn at line 435, showAllyMenu",
      "internal/client/gameplay_dialogs.go - drawAllyMenu() at line 749",
      "internal/game/player.go - Player struct with Eliminated field at line 49",
      "internal/game/combat.go - checkElimination() at line 422",
      "internal/game/state.go - victory condition checks"
    ]
  }
]
